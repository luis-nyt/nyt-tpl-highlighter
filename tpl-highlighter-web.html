<!DOCTYPE html>
<html>
<head>
    <title>TPL Web Usage Analyzer</title>
    <style>
        body { 
            font-family: NYTFranklin, 'Libre Franklin', -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 700px; 
            margin: 0 auto; 
            padding: 15px; 
            line-height: 1.5; 
            background: white;
            color: #333;
        }
        .container { 
            padding: 15px 0; 
            margin: 20px 0;
        }
        .bookmarklet-section { 
            padding: 15px 0; 
            margin: 15px 0;
        }
        .bookmarklet-link {
            background: #326891;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 4px;
            font-weight: 500;
            font-size: 14px;
            display: inline-block;
            margin: 10px 0;
            cursor: move;
            transition: background 0.2s;
        }
        .bookmarklet-link:hover { 
            background: #2d5a82; 
        }
        .manual-section { 
            padding: 15px 0; 
            margin: 15px 0; 
        }
        .features {
            padding: 15px 0;
            margin: 15px 0;
        }
        .code-input {
            width: 100%;
            height: 50px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 11px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f8f9fa;
            resize: vertical;
        }
        .copy-btn {
            background: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 400;
            margin-top: 8px;
            font-size: 13px;
        }
        .copy-btn:hover {
            background: #e9ecef;
            color: #333;
        }
        .step {
            padding: 8px 0;
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TPL Web Usage Analyzer</h1>
        <p>Analyze TPL design system usage on New York Times pages.</p>
    </div>

    <div class="bookmarklet-section">
        <h2>Installation</h2>
        <p><strong>Step 1:</strong> Drag the link below to your browser's bookmarks bar</p>
        
        <a id="bookmarkletLink" class="bookmarklet-link">TPL Analyzer</a>
        
        <p><strong>Step 2:</strong> Go to any nytimes.com page and click the bookmarklet</p>
    </div>

    <div class="manual-section">
        <h2>Manual Installation</h2>
        <p>If dragging doesn't work, copy the code below and create a new bookmark with it as the URL:</p>
        
        <textarea id="bookmarkletCode" class="code-input" readonly onclick="this.select()"></textarea>
        <br>
        <button class="copy-btn" onclick="copyCode()">Copy Bookmarklet Code</button>
        
    </div>

    <div class="features">
        <h2>Features</h2>
        <ul>
            <li><strong>TPL Element Detection:</strong> Finds all elements with TPL-related CSS classes</li>
            <li><strong>Screen Coverage Analysis:</strong> Calculates percentage of page area covered by TPL components</li>
            <li><strong>Clean Highlighting:</strong> Orange outlines on TPL elements without text labels</li>
            <li><strong>Dynamic Bottom Bar:</strong> Shows total page coverage and real-time viewport coverage</li>
            <li><strong>Smart Screenshot:</strong> Pre-loads page content and waits for dynamic elements before capture</li>
            <li><strong>Interactive Tooltips:</strong> Click highlighted elements for detailed information</li>
            <li><strong>Toggle Functionality:</strong> Click bookmarklet again to turn off/on</li>
        </ul>
    </div>

    <script>
        // The bookmarklet code - with top bar and screenshot functionality
        const bookmarkletCode = `javascript:(function(){if(window.tplWorking){window.tplWorking.toggle();return;}var s=document.createElement('style');s.textContent='.tpl-h{outline:2px solid #ff6b35!important;background:rgba(255,107,53,0.1)!important;cursor:pointer!important}.tpl-h:hover{outline-width:3px!important;background:rgba(255,107,53,0.2)!important}.tpl-badge{position:absolute!important;background:#ff6b35!important;color:white!important;font:600 9px monospace!important;padding:2px 5px!important;border-radius:3px!important;z-index:9999!important;pointer-events:none!important;box-shadow:0 2px 4px rgba(0,0,0,0.2)!important}.tpl-bottombar{position:fixed!important;bottom:20px!important;left:50%!important;transform:translateX(-50%)!important;background:#8B0000!important;color:white!important;padding:12px 20px!important;font:14px NYTFranklin,Georgia,serif!important;z-index:10000!important;display:flex!important;justify-content:space-between!important;align-items:center!important;min-width:500px!important;max-width:700px!important}.tpl-coverage-number{font-family:monospace!important}.tpl-topbar-text{margin:0!important;font-weight:500!important}.tpl-btn{background:#fff!important;color:#8B0000!important;border:none!important;padding:6px 12px!important;border-radius:4px!important;font:12px NYTFranklin,Georgia,serif!important;cursor:pointer!important;font-weight:600!important;margin-left:10px!important;margin-right:15px!important}.tpl-btn:hover{background:#f0f0f0!important}.tpl-close-btn{background:transparent!important;color:white!important;border:none!important;padding:4px 8px!important;border-radius:3px!important;font:12px NYTFranklin,Georgia,serif!important;cursor:pointer!important}.tpl-close-btn:hover{background:rgba(255,255,255,0.1)!important}';document.head.appendChild(s);var T={active:false,elements:[],bottombar:null,scrollListener:null,totalCoveragePercent:0,detect:function(){var all=document.querySelectorAll('*'),totalArea=0,pageArea=Math.max(document.body.scrollHeight||0,document.documentElement.scrollHeight||0)*Math.max(document.body.scrollWidth||0,document.documentElement.scrollWidth||0);T.elements=[];all.forEach(function(el){var cls=el.className;if(typeof cls==='string'&&cls.indexOf('tpl')>-1&&!cls.includes('tpl-bottombar')&&!cls.includes('tpl-coverage')&&!cls.includes('tpl-btn')&&!cls.includes('tpl-close')){var classes=cls.split(' ').filter(function(c){return c.indexOf('tpl')>-1&&!c.includes('tpl-bottombar')&&!c.includes('tpl-coverage')&&!c.includes('tpl-btn')&&!c.includes('tpl-close')});if(classes.length>0){var rect=el.getBoundingClientRect(),area=rect.width*rect.height;totalArea+=area;T.elements.push({el:el,classes:classes,area:area,rect:rect})}}});T.totalCoveragePercent=(totalArea/pageArea*100).toFixed(1);return T.elements.length},calculateViewportCoverage:function(){var viewportArea=window.innerWidth*window.innerHeight,visibleTPLArea=0;T.elements.forEach(function(item){var rect=item.el.getBoundingClientRect();if(rect.bottom>0&&rect.top<window.innerHeight&&rect.right>0&&rect.left<window.innerWidth){var visibleWidth=Math.min(rect.right,window.innerWidth)-Math.max(rect.left,0);var visibleHeight=Math.min(rect.bottom,window.innerHeight)-Math.max(rect.top,0);if(visibleWidth>0&&visibleHeight>0){visibleTPLArea+=visibleWidth*visibleHeight}}});return(visibleTPLArea/viewportArea*100).toFixed(1)},updateBottombar:function(){if(!T.bottombar)return;var viewportCoverage=T.calculateViewportCoverage();T.bottombar.querySelector('.tpl-coverage-text').innerHTML='The entire page shows <span class="tpl-coverage-number"><strong>'+T.totalCoveragePercent+'%</strong></span> TPL visual coverage.<br><br>Your current view shows <span class="tpl-coverage-number"><strong>'+viewportCoverage+'%</strong></span>.'},createBottombar:function(){if(T.bottombar)T.bottombar.remove();T.bottombar=document.createElement('div');T.bottombar.className='tpl-bottombar';var initialViewport=T.calculateViewportCoverage();T.bottombar.innerHTML='<div class="tpl-coverage-text">The entire page shows <span class="tpl-coverage-number"><strong>'+T.totalCoveragePercent+'%</strong></span> TPL visual coverage.<br><br>Your current view shows <span class="tpl-coverage-number"><strong>'+initialViewport+'%</strong></span>.</div><div><button class="tpl-btn" onclick="window.tplWorking.screenshot()">ðŸ“¸ Screenshot</button><button class="tpl-close-btn" onclick="window.tplWorking.deactivate()">âœ•</button></div>';document.body.appendChild(T.bottombar);T.scrollListener=function(){T.updateBottombar()};window.addEventListener('scroll',T.scrollListener);window.addEventListener('resize',T.scrollListener)},preloadPage:function(callback){var btn=T.bottombar.querySelector('.tpl-btn');btn.textContent='ðŸ“¸ Loading page...';var originalScrollY=window.scrollY;var scrollStep=window.innerHeight*0.8;var currentScroll=0;var maxScroll=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight)-window.innerHeight;var scrollDown=function(){if(currentScroll<maxScroll){currentScroll=Math.min(currentScroll+scrollStep,maxScroll);window.scrollTo(0,currentScroll);setTimeout(scrollDown,200)}else{btn.textContent='ðŸ“¸ Waiting for content...';setTimeout(function(){window.scrollTo(0,originalScrollY);btn.textContent='ðŸ“¸ Capturing...';setTimeout(callback,500)},1000)}};scrollDown()},screenshot:function(){var btn=T.bottombar.querySelector('.tpl-btn');btn.disabled=true;T.preloadPage(function(){if(typeof html2canvas!=='undefined'){T.captureWithHtml2Canvas()}else{var script=document.createElement('script');script.src='https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';script.onload=function(){T.captureWithHtml2Canvas()};script.onerror=function(){T.fallbackScreenshot()};document.head.appendChild(script)}})},captureWithHtml2Canvas:function(){var originalScrollY=window.scrollY;window.scrollTo(0,0);document.querySelectorAll('.tpl-badge').forEach(function(b){b.style.display='none'});T.bottombar.style.display='none';html2canvas(document.documentElement,{useCORS:true,allowTaint:true,scale:0.8,scrollX:0,scrollY:0,width:Math.max(document.body.scrollWidth,document.documentElement.scrollWidth),height:Math.max(document.body.scrollHeight,document.documentElement.scrollHeight),windowWidth:Math.max(document.body.scrollWidth,document.documentElement.scrollWidth),windowHeight:Math.max(document.body.scrollHeight,document.documentElement.scrollHeight)}).then(function(canvas){var link=document.createElement('a');link.download='tpl-analysis-'+new Date().toISOString().slice(0,10)+'.png';link.href=canvas.toDataURL('image/png');link.click();document.querySelectorAll('.tpl-badge').forEach(function(b){b.style.display=''});T.bottombar.style.display='flex';window.scrollTo(0,originalScrollY);var btn=T.bottombar.querySelector('.tpl-btn');btn.textContent='ðŸ“¸ Screenshot';btn.disabled=false}).catch(function(e){console.error('Screenshot failed:',e);document.querySelectorAll('.tpl-badge').forEach(function(b){b.style.display=''});T.bottombar.style.display='flex';window.scrollTo(0,originalScrollY);T.fallbackScreenshot()})},fallbackScreenshot:function(){alert('Screenshot functionality requires html2canvas library. You can manually take a screenshot using your browser\\'s built-in screenshot tools (usually Cmd/Ctrl + Shift + S).');var btn=T.bottombar.querySelector('.tpl-btn');btn.textContent='ðŸ“¸ Screenshot';btn.disabled=false},refreshDetection:function(){if(!T.active)return;T.elements.forEach(function(item){item.el.classList.remove('tpl-h')});T.detect();T.elements.forEach(function(item){var el=item.el;el.classList.add('tpl-h');el.addEventListener('click',function(e){e.preventDefault();e.stopPropagation();var tooltip=document.createElement('div');tooltip.style.cssText='position:absolute!important;background:#1f2937!important;color:white!important;padding:8px!important;border-radius:4px!important;z-index:9999!important;font:11px NYTFranklin,Georgia,serif!important;max-width:250px!important;box-shadow:0 4px 8px rgba(0,0,0,0.3)!important';tooltip.innerHTML='<strong>'+el.tagName+'</strong><br>TPL Classes: '+item.classes.join(', ')+'<br>Area: '+el.getBoundingClientRect().width.toFixed(0)+'Ã—'+el.getBoundingClientRect().height.toFixed(0)+'px';var rect=el.getBoundingClientRect();tooltip.style.left=rect.left+window.scrollX+'px';tooltip.style.top=rect.bottom+window.scrollY+5+'px';document.body.appendChild(tooltip);setTimeout(function(){tooltip.remove()},3000)})});T.updateBottombar()},activate:function(){if(T.active)return;T.active=true;T.elements.forEach(function(item){var el=item.el;el.classList.add('tpl-h');el.addEventListener('click',function(e){e.preventDefault();e.stopPropagation();var tooltip=document.createElement('div');tooltip.style.cssText='position:absolute!important;background:#1f2937!important;color:white!important;padding:8px!important;border-radius:4px!important;z-index:9999!important;font:11px NYTFranklin,Georgia,serif!important;max-width:250px!important;box-shadow:0 4px 8px rgba(0,0,0,0.3)!important';tooltip.innerHTML='<strong>'+el.tagName+'</strong><br>TPL Classes: '+item.classes.join(', ')+'<br>Area: '+el.getBoundingClientRect().width.toFixed(0)+'Ã—'+el.getBoundingClientRect().height.toFixed(0)+'px';var rect=el.getBoundingClientRect();tooltip.style.left=rect.left+window.scrollX+'px';tooltip.style.top=rect.bottom+window.scrollY+5+'px';document.body.appendChild(tooltip);setTimeout(function(){tooltip.remove()},3000)})});T.createBottombar();setTimeout(function(){T.refreshDetection()},3000)},deactivate:function(){if(!T.active)return;T.active=false;T.elements.forEach(function(item){item.el.classList.remove('tpl-h')});document.querySelectorAll('.tpl-badge').forEach(function(b){b.remove()});if(T.bottombar){T.bottombar.remove();T.bottombar=null}if(T.scrollListener){window.removeEventListener('scroll',T.scrollListener);window.removeEventListener('resize',T.scrollListener);T.scrollListener=null}},toggle:function(){if(T.active){T.deactivate();return'deactivated'}else{var count=T.detect();T.activate();return'activated - found '+count+' TPL elements ('+T.totalCoveragePercent+'% total coverage)'}}};window.tplWorking=T;var result=T.toggle();alert('TPL Analyzer '+result+'!');})();`;

        // Set up the bookmarklet link and textarea
        document.addEventListener('DOMContentLoaded', function() {
            const link = document.getElementById('bookmarkletLink');
            const textarea = document.getElementById('bookmarkletCode');
            
            link.href = bookmarkletCode;
            textarea.value = bookmarkletCode;
        });

        function copyCode() {
            const textarea = document.getElementById('bookmarkletCode');
            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                alert('Bookmarklet code copied to clipboard!\n\nNow create a new bookmark and paste this as the URL.');
            } catch (err) {
                alert('Copy failed. Please manually select and copy the code from the text area.');
            }
        }
    </script>
</body>
</html>
