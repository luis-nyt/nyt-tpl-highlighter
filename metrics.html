<!DOCTYPE html>
<html>
<head>
    <title>TPL Adoption Metrics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
            color: #000;
            background: #fff;
            padding: 20px;
        }

        h1 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'IBM Plex Mono', monospace;
        }

        th, td {
            text-align: left;
            padding: 8px 12px;
            border-bottom: 1px solid #ddd;
            font-size: 11px;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        th {
            font-weight: 600;
            background: #f8f8f8;
        }

        .loading {
            font-style: italic;
            color: #666;
        }

        .loading-dots::after {
            content: '';
            animation: loading-dots 1.5s infinite;
        }

        @keyframes loading-dots {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
            100% { content: '.'; }
        }

        .error {
            color: #d00;
        }

        .number {
            text-align: center;
        }

        .number th {
            text-align: center;
        }

        .viewport-tag {
            font-size: 9px;
            padding: 2px 4px;
            background: #eee;
            border-radius: 2px;
            margin-left: 4px;
        }
    </style>
</head>
<body>
    <h1>TPL Adoption Metrics</h1>
    
    <div id="loading" class="loading">Loading data<span class="loading-dots"></span></div>
    <div id="error" class="error" style="display: none;"></div>
    
    <table id="metricsTable" style="display: none;">
        <thead>
            <tr>
                <th>Date</th>
                <th>Surface</th>
                <th class="number">Avg TPL Coverage</th>
                <th class="number">Mobile TPL Cov</th>
                <th class="number">Desktop TPL Cov</th>
                <th class="number">Components</th>
                <th class="number">TPL Tokenization %</th>
            </tr>
        </thead>
        <tbody id="metricsBody">
        </tbody>
    </table>

    <script>
        async function loadMetrics() {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const tableEl = document.getElementById('metricsTable');
            const bodyEl = document.getElementById('metricsBody');

            try {
                // Get list of available files from directory index
                const indexResponse = await fetch('./data/daily/index.json');
                if (!indexResponse.ok) {
                    throw new Error('Could not load file index');
                }
                
                const availableFiles = await indexResponse.json();
                console.log(`ðŸ“‚ Found ${availableFiles.length} files in directory index`);
                
                const metrics = [];
                
                // Load each file from the index
                for (const filename of availableFiles) {
                    try {
                        const response = await fetch(`./data/daily/${filename}`);
                        if (response.ok) {
                            const data = await response.json();
                            metrics.push({ filename, data });
                        }
                    } catch (e) {
                        console.warn(`Could not load ${filename}:`, e);
                    }
                }
                
                console.log(`ðŸ“Š Successfully loaded ${metrics.length} data files`);

                if (metrics.length === 0) {
                    throw new Error('No data files could be loaded');
                }

                // Sort by date (newest first)
                metrics.sort((a, b) => b.data.date.localeCompare(a.data.date));

                // Render table
                bodyEl.innerHTML = '';
                metrics.forEach(({ filename, data }) => {
                    const row = createTableRow(data, filename);
                    bodyEl.appendChild(row);
                });

                loadingEl.style.display = 'none';
                tableEl.style.display = 'table';

            } catch (error) {
                console.error('Error loading metrics:', error);
                loadingEl.style.display = 'none';
                errorEl.textContent = `Error: ${error.message}`;
                errorEl.style.display = 'block';
            }
        }

        function createTableRow(data, filename) {
            const row = document.createElement('tr');
            
            // Extract data based on schema
            const date = data.date || 'unknown';
            let time = 'unknown';
            
            // Extract time from filename (e.g., "2025-09-25-0343-multiview.json" -> "03:43")
            const timeMatch = filename.match(/(\d{4})-(\d{2})-(\d{2})-(\d{4})/);
            if (timeMatch) {
                const timeStr = timeMatch[4];
                time = `${timeStr.slice(0, 2)}:${timeStr.slice(2, 4)}`;
            } else if (filename.includes('multiview') && !filename.includes('-0')) {
                time = 'day';
            }
            
            let type = data.type || (filename.includes('multiview') ? 'multiview' : 'single');
            
            // Make type more descriptive based on what's being analyzed
            if (data.viewportSummaries && data.viewportSummaries.mobile && data.viewportSummaries.mobile.pages) {
                const firstPage = data.viewportSummaries.mobile.pages[0];
                if (firstPage && firstPage.url && firstPage.url.includes('nytimes.com')) {
                    if (firstPage.section === 'home' || firstPage.pageType === 'homepage') {
                        type = 'NYT Home Web';
                    } else {
                        type = `NYT ${firstPage.section || 'Unknown'} Web`;
                    }
                }
            } else if (data.pages && data.pages.length > 0) {
                const firstPage = data.pages[0];
                if (firstPage && firstPage.url && firstPage.url.includes('nytimes.com')) {
                    if (firstPage.section === 'home' || firstPage.pageType === 'homepage') {
                        type = 'NYT Home Web';
                    } else {
                        type = `NYT ${firstPage.section || 'Unknown'} Web`;
                    }
                }
            }
            
            let avgCoverage = 0;
            let mobileCov = '-';
            let desktopCov = '-';
            let elementCount = 0;

            if (data.viewportSummaries) {
                // Multi-viewport data
                const mobile = data.viewportSummaries.mobile;
                const desktop = data.viewportSummaries.desktop;
                
                if (mobile && desktop) {
                    avgCoverage = ((mobile.averageCoverage + desktop.averageCoverage) / 2).toFixed(1);
                    mobileCov = mobile.averageCoverage.toFixed(1);
                    desktopCov = desktop.averageCoverage.toFixed(1);
                    
                    // Get element count from first page
                    if (mobile.pages && mobile.pages[0]) {
                        elementCount = mobile.pages[0].elementCount || 0;
                    }
                }
            } else if (data.pages) {
                // Single viewport data
                if (data.pages.length > 0) {
                    avgCoverage = (data.pages.reduce((sum, p) => sum + (p.tplCoverage || 0), 0) / data.pages.length).toFixed(1);
                    elementCount = data.pages.reduce((sum, p) => sum + (p.elementCount || 0), 0);
                }
            }

            // Combine date and time
            const dateTime = time !== 'unknown' && time !== 'day' ? `${date} ${time}` : date;

            row.innerHTML = `
                <td>${dateTime}</td>
                <td>${type}</td>
                <td class="number">${avgCoverage}%</td>
                <td class="number">${mobileCov}${mobileCov !== '-' ? '%' : ''}</td>
                <td class="number">${desktopCov}${desktopCov !== '-' ? '%' : ''}</td>
                <td class="number">${elementCount}</td>
                <td class="number">-</td>
            `;

            return row;
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadMetrics);
    </script>
</body>
</html>
